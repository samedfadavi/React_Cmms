import {
  p
} from "./chunk-7TO4QD67.js";
import {
  x
} from "./chunk-PHVKM5OH.js";
import {
  S
} from "./chunk-KQ5GHUVQ.js";
import {
  C,
  a as a3
} from "./chunk-FADA7L64.js";
import {
  _
} from "./chunk-7R5XEKR3.js";
import {
  o
} from "./chunk-ZART2Y5J.js";
import {
  r
} from "./chunk-F4OBDVPS.js";
import {
  K,
  N,
  U,
  W,
  t2 as t
} from "./chunk-WC4SPMPL.js";
import {
  y
} from "./chunk-TJUEGVVG.js";
import {
  a3 as a
} from "./chunk-GEH2VXFC.js";
import {
  e
} from "./chunk-BJY5ADVY.js";
import {
  a as a2,
  b,
  s as s3
} from "./chunk-VMWKLHJD.js";
import {
  u
} from "./chunk-5AEITAWU.js";
import {
  n2 as n,
  s,
  s2
} from "./chunk-YNL57W4I.js";

// ../node_modules/@arcgis/core/layers/mixins/PortalLayer.js
var j = (j2) => {
  let _2 = class extends j2 {
    constructor() {
      super(...arguments), this.resourceReferences = { portalItem: null, paths: [] }, this.userHasEditingPrivileges = true, this.userHasFullEditingPrivileges = false, this.userHasUpdateItemPrivileges = false;
    }
    destroy() {
      this.portalItem = u(this.portalItem), this.resourceReferences.portalItem = null, this.resourceReferences.paths.length = 0;
    }
    set portalItem(t2) {
      t2 !== this._get("portalItem") && (this.removeOrigin("portal-item"), this._set("portalItem", t2));
    }
    readPortalItem(t2, e2, r2) {
      if (e2.itemId) return new S({ id: e2.itemId, portal: r2 == null ? void 0 : r2.portal });
    }
    writePortalItem(t2, e2) {
      (t2 == null ? void 0 : t2.id) && (e2.itemId = t2.id);
    }
    async loadFromPortal(t2, e2) {
      var _a;
      if ((_a = this.portalItem) == null ? void 0 : _a.id) try {
        const { load: r2 } = await import("./layersLoader-X4LMCYLO.js");
        return s3(e2), await r2({ instance: this, supportedTypes: t2.supportedTypes, validateItem: t2.validateItem, supportsData: t2.supportsData, layerModuleTypeMap: t2.layerModuleTypeMap }, e2);
      } catch (r2) {
        throw b(r2) || n.getLogger(this).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${r2}`), r2;
      }
    }
    async finishLoadEditablePortalLayer(t2) {
      this._set("userHasEditingPrivileges", await this._fetchUserHasEditingPrivileges(t2).catch((t3) => (a2(t3), true)));
    }
    async setUserPrivileges(t2, r2) {
      if (!s.userPrivilegesApplied) return this.finishLoadEditablePortalLayer(r2);
      if (this.url) try {
        const { features: { edit: e2, fullEdit: s4 }, content: { updateItem: i } } = await this._fetchUserPrivileges(t2, r2);
        this._set("userHasEditingPrivileges", e2), this._set("userHasFullEditingPrivileges", s4), this._set("userHasUpdateItemPrivileges", i);
      } catch (s4) {
        a2(s4);
      }
    }
    async _fetchUserPrivileges(t2, e2) {
      var _a;
      let s4 = this.portalItem;
      if (!t2 || !s4 || !s4.loaded || s4.sourceUrl) return this._fetchFallbackUserPrivileges(e2);
      const i = t2 === s4.id;
      if (i && s4.portal.user) return p(s4);
      let o2, a4;
      if (i) o2 = s4.portal.url;
      else try {
        o2 = await x(this.url, e2);
      } catch (d) {
        a2(d);
      }
      if (!o2 || !W(o2, s4.portal.url)) return this._fetchFallbackUserPrivileges(e2);
      try {
        const t3 = null != e2 ? e2.signal : null;
        a4 = await ((_a = t) == null ? void 0 : _a.getCredential(`${o2}/sharing`, { prompt: false, signal: t3 }));
      } catch (d) {
        a2(d);
      }
      const l = true, n2 = false, p2 = false;
      if (!a4) return { features: { edit: l, fullEdit: n2 }, content: { updateItem: p2 } };
      try {
        if (i ? await s4.reload() : (s4 = new S({ id: t2, portal: { url: o2 } }), await s4.load(e2)), s4.portal.user) return p(s4);
      } catch (d) {
        a2(d);
      }
      return { features: { edit: l, fullEdit: n2 }, content: { updateItem: p2 } };
    }
    async _fetchFallbackUserPrivileges(t2) {
      let e2 = true;
      try {
        e2 = await this._fetchUserHasEditingPrivileges(t2);
      } catch (r2) {
        a2(r2);
      }
      return { features: { edit: e2, fullEdit: false }, content: { updateItem: false } };
    }
    async _fetchUserHasEditingPrivileges(t2) {
      var _a;
      const e2 = this.url ? (_a = t) == null ? void 0 : _a.findCredential(this.url) : null;
      if (!e2) return true;
      const s4 = E.credential === e2 ? E.user : await this._fetchEditingUser(t2);
      return E.credential = e2, E.user = s4, null == (s4 == null ? void 0 : s4.privileges) || s4.privileges.includes("features:user:edit");
    }
    async _fetchEditingUser(t2) {
      var _a, _b, _c;
      const e2 = (_b = (_a = this.portalItem) == null ? void 0 : _a.portal) == null ? void 0 : _b.user;
      if (e2) return e2;
      const o2 = (_c = t) == null ? void 0 : _c.findServerInfo(this.url ?? "");
      if (!(o2 == null ? void 0 : o2.owningSystemUrl)) return null;
      const a4 = `${o2.owningSystemUrl}/sharing/rest`, l = C.getDefault();
      if (l && l.loaded && K(l.restUrl) === K(a4)) return l.user;
      const n2 = `${a4}/community/self`, p2 = null != t2 ? t2.signal : null, u2 = await _(U(n2, { authMode: "no-prompt", query: { f: "json" }, signal: p2 }));
      return u2.ok ? a3.fromJSON(u2.value.data) : null;
    }
    read(t2, e2) {
      e2 && (e2.layer = this), super.read(t2, e2);
    }
    write(t2, e2) {
      var _a;
      const r2 = e2 == null ? void 0 : e2.portal, s4 = ((_a = this.portalItem) == null ? void 0 : _a.id) && (this.portalItem.portal || C.getDefault());
      return r2 && s4 && !N(s4.restUrl, r2.restUrl) ? (e2.messages && e2.messages.push(new s2("layer:cross-portal", `The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`, { layer: this })), null) : super.write(t2, { ...e2, layer: this });
    }
  };
  return e([y({ type: S })], _2.prototype, "portalItem", null), e([o("web-document", "portalItem", ["itemId"])], _2.prototype, "readPortalItem", null), e([r("web-document", "portalItem", { itemId: { type: String } })], _2.prototype, "writePortalItem", null), e([y({ clonable: false })], _2.prototype, "resourceReferences", void 0), e([y({ type: Boolean, readOnly: true })], _2.prototype, "userHasEditingPrivileges", void 0), e([y({ type: Boolean, readOnly: true })], _2.prototype, "userHasFullEditingPrivileges", void 0), e([y({ type: Boolean, readOnly: true })], _2.prototype, "userHasUpdateItemPrivileges", void 0), _2 = e([a("esri.layers.mixins.PortalLayer")], _2), _2;
};
var E = { credential: null, user: null };

export {
  j
};
//# sourceMappingURL=chunk-5LNCGIUN.js.map
